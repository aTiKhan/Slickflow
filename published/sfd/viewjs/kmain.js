import jquery from"jquery";import{debounce}from"min-dash";import slick from"../script/slick.event.js";window.slick=slick;import jshelper from"../script/jshelper.js";window.jshelper=jshelper;import processlist from"../viewjs/processlist.js";window.processlist=processlist;import rolelist from"../viewjs/rolelist.js";window.rolelist=rolelist;import kresource from"../viewjs/kresource.js";window.kresource=kresource;import kmsgbox from"../script/kmsgbox.js";window.kmsgbox=kmsgbox;import processapi from"../viewjs/processapi.js";window.processapi=processapi;const kmain=function(){function e(){}e.mProcessID=0,e.mProcessGUID="",e.mProcessVersion="",e.mBpmnModeler=null,e.mxSelectedProcessEntity=null,e.init=function(o){$(".progress-bar").animate({width:"70%"},200),setTimeout((function(){$(".progress").hide()}),1e3),e.mBpmnModeler=o,void 0!==processlist&&(processlist.afterCreated.subscribe(t),processlist.afterOpened.subscribe(n),processlist.diagramCreated.subscribe(r)),s()};var s=function(){e.mxSelectedProcessEntity=null};async function o(s){try{var o=$("#js-drop-zone");await e.mBpmnModeler.importXML(s),o.removeClass("with-error").addClass("with-diagram")}catch(e){o.removeClass("with-diagram").addClass("with-error"),o.find(".error pre").text(e.message),console.error(e)}}function r(o,r){s(),e.mxSelectedProcessEntity=r.ProcessEntity,e.mBpmnModeler.saveXML({format:!0}).then((function(s){var o=s.xml;if(null!==r.ProcessEntity){var t={ProcessGUID:e.mxSelectedProcessEntity.ProcessGUID,ProcessName:e.mxSelectedProcessEntity.ProcessName,ProcessCode:e.mxSelectedProcessEntity.ProcessCode,Version:e.mxSelectedProcessEntity.Version,XmlContent:o};processapi.saveProcessFile(t,(function(e){1!==e.Status?kmsgbox.error(kresource.getItem("processxmlsaveerrormsg"),kmsgbox.result.Message):kmsgbox.info(kresource.getItem("processxmlsaveokmsg"))}))}else kmsgbox.error(kresource.getItem("processxmlsaveerrormsg"))}))}function t(e,o){s()}function n(r,t){s();var n={ProcessGUID:t.ProcessEntity.ProcessGUID,Version:t.ProcessEntity.Version};processapi.queryProcessFile(n,(function(s){if(1===s.Status){var r=s.Entity;o(r.XmlContent),e.mxSelectedProcessEntity=r}else kmsgbox.error(kresource.getItem("processopenerrormsg"),s.Message)}))}function i(e,s){var o=document.createElement("a");o.setAttribute("href","data:application/bpmn20-xml;charset=UTF-8,"+encodeURIComponent(s)),o.setAttribute("download",e),document.body.appendChild(o),o.click(),document.body.removeChild(o)}return e.createNewDiagram=function(){e.mxSelectedProcessEntity=null,processapi.InitNewBPMNFile((function(s){null!==s.Entity&&(e.mxSelectedProcessEntity=s.Entity,o(s.Entity.XmlContent))}))},e.openDiagramFile=function(e){o(e)},e.openProcess=function(){require("bootstrap5-dialog").show({message:$('<div id="popupContent"></div>'),title:kresource.getItem("processlist"),onshown:function(){$("#popupContent").load("pages/process/list.html")},draggable:!0})},e.saveProcessFile=function(s,o){const r=e.mBpmnModeler.get("canvas").getRootElement(),t=r.businessObject.name,n=r.businessObject.code;if(t!==s.ProcessName){var i=kresource.getItem("processnamechangedconfirmmsg");kmsgbox.confirm(i,(function(){var e={ProcessGUID:s.ProcessGUID,ProcessName:t,ProcessCode:n,Version:s.Version,IsUsing:s.IsUsing,XmlContent:o};processapi.saveProcessFile(e,(function(e){1===e.Status?kmsgbox.info(kresource.getItem("processxmlsaveokmsg")):kmsgbox.error(kresource.getItem("processxmlsaveerrormsg"),e.Message)}))}))}else{var c={ProcessGUID:s.ProcessGUID,ProcessName:s.ProcessName,ProcessCode:s.ProcessCode,Version:s.Version,IsUsing:s.IsUsing,XmlContent:o};processapi.saveProcessFile(c,(function(e){1===e.Status?kmsgbox.info(kresource.getItem("processxmlsaveokmsg")):kmsgbox.error(kresource.getItem("processxmlsaveerrormsg"),e.Message)}))}},e.previewXml=function(){require("bootstrap5-dialog").show({message:$('<div id="popupXmlContent"></div>'),title:kresource.getItem("content"),onshown:function(){$("#popupXmlContent").load("pages/process/xmlcontent.html")},draggable:!0})},e.downloadXml=debounce((async function(){try{const{xml:e}=await this.mBpmnModeler.saveXML({format:!0});i("diagram.bpmn",e)}catch(e){console.error("Error happened saving diagram: ",e),i("diagram.bpmn",null)}}),500),e.downloadSvg=debounce((async function(){try{const{svg:e}=await this.mBpmnModeler.saveSVG();i("diagram.svg",e)}catch(e){console.error("Error happened saving SVG: ",e),i("diagram.svg",null)}}),500),e.importDiagram=function(){require("bootstrap5-dialog").show({message:$('<div id="popupImportXml"></div>'),title:kresource.getItem("importxml"),onshown:function(){$("#popupImportXml").load("pages/process/import.html")},draggable:!0})},e.validateProcess=function(){console.log("validate process...")},e.createFromTemplate=function(){e.mxSelectedProcessEntity=null,processlist.pselectedProcessEntity=null;var s=require("bootstrap5-dialog");e.templateDialog=s.show({message:$('<div id="createFromTemplate"></div>'),title:kresource.getItem("createfromtemplate"),onshown:function(){$("#createFromTemplate").load("pages/process/template.html")},draggable:!0})},e.codeStudio=function(){window.open("pages/model/index.html","_blank").focus()},e.gotoTutorial=function(){processmodel.gotoTutorial()},e.simuTest=function(){window.open(kconfig.webTestUrl,"_blank").focus()},e.webJob=function(){window.open("http://localhost/sfj2/","_blank").focus()},e.changeLang=function(e){kresource.setLang(e),window.location.reload()},e}();export default kmain;